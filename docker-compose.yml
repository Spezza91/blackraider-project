services:
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8080:8080 # Porta WebUI qBittorrent (passa da qui!)
      - 6881:6881 # Porta Torrent TCP
      - 6881:6881/udp # Porta Torrent UDP
    volumes:
      - ./config/gluetun:/gluetun
      - ./gluetun_shared:/tmp/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${PROTON_PRIVATE_KEY}
      - SERVER_COUNTRIES=Switzerland # O Netherlands, Iceland...
      - VPN_PORT_FORWARDING=on # Attiva il Port Forwarding
    restart: unless-stopped

  # --- MICROSERVIZIO CUSTOM ---
  qbit-sync:
    image: spezza91/qbit-sync:latest
    container_name: qbit-sync
    volumes:
      - ./gluetun_shared:/shared:ro
    environment:
      - QBIT_HOST=http://gluetun:8080
      - QBIT_USER=${QUSER}
      - QBIT_PASS=${QPASS}
    depends_on:
      - qbittorrent
      - gluetun
    restart: unless-stopped

  # --- GESTORE DOWNLOAD ---
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
    volumes:
      - ./config/qbittorrent:/config
      - /mnt/media/data:/data
    network_mode: service:gluetun
    depends_on:
      - gluetun
    restart: unless-stopped

  # --- INDEXER MANAGER ---
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/prowlarr:/config
    ports:
      - 9696:9696
    restart: unless-stopped

  # --- ANTI-CAPTCHA ---
  flaresolverr:
    image: flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
    ports:
      - 8191:8191
    restart: unless-stopped

  # --- GESTORE SERIE TV ---
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/sonarr:/config
      - /mnt/media/data:/data
    ports:
      - 8989:8989
    depends_on:
      - qbittorrent
      - prowlarr
    restart: unless-stopped

  # --- GESTORE FILM ---
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/radarr:/config
      - /mnt/media/data:/data
    ports:
      - 7878:7878
    depends_on:
      - qbittorrent
      - prowlarr
    restart: unless-stopped

  # --- GESTORE SOTTOTITOLI ---
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Rome
    volumes:
      - ./config/bazarr:/config
      - /mnt/media/data:/data
    ports:
      - 6767:6767
    restart: unless-stopped

  # --- INTERFACCIA RICHIESTE (Jellyseerr) ---
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    environment:
      - LOG_LEVEL=info
      - TZ=Europe/Rome
    ports:
      - 5055:5055
    volumes:
      - ./config/jellyseerr:/app/config
    restart: unless-stopped

  # --- OTTIMIZZATORE SPAZIO (Tdarr) ---
  tdarr:
    container_name: tdarr
    image: ghcr.io/haveagitgat/tdarr:latest
    restart: unless-stopped
    network_mode: bridge
    ports:
      - 8265:8265 # WebUI
      - 8266:8266 # Server port
    environment:
      - TZ=Europe/Rome
      - PUID=1000
      - PGID=1000
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true # Il "lavoratore" Ã¨ integrato
      - nodeID=BlackRaiderNode
    volumes:
      - ./config/tdarr/server:/app/server
      - ./config/tdarr/configs:/app/configs
      - ./config/tdarr/logs:/app/logs
      - /mnt/media/data/media:/media # La cartella da scansionare e convertire
      - /tmp:/temp # Cartella temporanea per la conversione
    devices:
      - /dev/dri:/dev/dri # <--- FONDAMENTALE: Usa la GPU Intel

  # --- MEDIA SERVER ---
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/jellyfin:/config
      - /mnt/media/data:/data
    ports:
      - 8096:8096
    devices:
      - /dev/dri:/dev/dri # Intel QuickSync ATTIVO ðŸš€
    restart: unless-stopped

  # --- LOG VIEWER ---
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 8888:8080
    restart: unless-stopped

  # --- DASHBOARD ---
  # --- DASHBOARD ---
  frontend:
    # Quando avrai fatto il primo push su GitHub, decommenta 'image' e commenta 'build'
    # image: ghcr.io/spezza91/test-project-frontend:latest 
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - 3000:80
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    depends_on:
      - socket-proxy

  # --- AUTO UPDATE ---
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true # Aggiorna solo i container con label specifica
      - WATCHTOWER_POLL_INTERVAL=300 # Controlla ogni 5 minuti
    restart: unless-stopped

  # homepage:
  #   image: ghcr.io/gethomepage/homepage:latest
  #   container_name: homepage
  #   volumes:
  #     - ./config/homepage:/app/config
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - /mnt/media/data:/data # Per vedere lo spazio disco
  #   ports:
  #     - 3001:3000 # Changed port to avoid conflict if enabled
  #   depends_on:
  #     - socket-proxy
  #   environment:
  #     - PUID=${PUID}
  #     - PGID=${PGID}
  #     - HOMEPAGE_ALLOWED_HOSTS=*
  #   restart: unless-stopped

  # --- GESTORE DOCKER ---
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    volumes:
      - ./config/portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 9000:9000
    restart: unless-stopped

  # --- DOCKER SOCKET PROXY (Per le statistiche) ---
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: socket-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # Montato in sola lettura
    environment:
      - CONTAINERS=1 # Permetti di leggere la lista container
      - POST=0 # Vieta di modificare/spegnere cose (Sicurezza)
    restart: unless-stopped
